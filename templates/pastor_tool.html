{% extends "base.html" %}
{% block title %}Pastor's Tool - District 4 Tool{% endblock %}

{% block content %}
<section class="card">
  <h2>Pastor's Tool</h2>

  <div style="display:flex; align-items:center; gap:12px; font-size:1rem; font-style:italic; margin-top:-5px; flex-wrap:wrap;">
    <div>Hello Pastor {{ pastor_name }}</div>

    {% if ao_mode %}
      <form method="get" action="{{ url_for('pastor_tool') }}" style="margin:0;">
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">

        <select name="church" onchange="this.form.submit()">
          {% for c in ao_church_choices %}
            {# Supports both formats:
               1) c is a dict/row: {username, church}
               2) c is a username string
               Prefer label from ao_church_labels if provided #}

            {% if c is mapping %}
              {% set u = c.username %}
              {% set label = (ao_church_labels.get(u) if ao_church_labels is defined else c.church) %}
            {% else %}
              {% set u = c %}
              {% set label = (ao_church_labels.get(u) if ao_church_labels is defined else u) %}
            {% endif %}

            <option value="{{ u }}" {% if u == selected_church %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </form>
    {% endif %}
  </div>

  <form method="get" class="month-picker">
    {# Keep selected church when AO changes Month/Year #}
    {% if ao_mode %}
      <input type="hidden" name="church" value="{{ selected_church }}">
    {% endif %}

    <div class="field-group">
      <label for="month">Month</label>
      <select id="month" name="month">
        {% for name, value in month_names %}
          <option value="{{ value }}" {% if value == month %}selected{% endif %}>
            {{ name }}{% if submitted_map is defined and submitted_map.get((year, value)) %} ✓{% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="field-group">
      <label for="year">Year</label>
      <select id="year" name="year">
        {% for y in year_options %}
          <option value="{{ y }}" {% if y == year %}selected{% endif %}>
            {{ y }}
          </option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn-secondary">Go</button>
  </form>

  <div class="sunday-list">
    {% if sunday_list %}
      {% for s in sunday_list %}
        <a href="{{ url_for('sunday_detail', year=s.year, month=s.month, day=s.day, church=(selected_church if ao_mode else None)) }}"
           class="sunday-card {% if s.is_complete %}complete{% else %}incomplete{% endif %}">
          <span>{{ s.display }}</span>
          <span class="status-pill">
            {% if s.is_complete %}Complete{% else %}Missing Data{% endif %}
          </span>
        </a>
      {% endfor %}
    {% else %}
      <p>No Sundays found for this month.</p>
    {% endif %}
  </div>

  <div class="progress-row">
    <a href="{{ url_for('church_progress_view', year=year, month=month, church=(selected_church if ao_mode else None)) }}"
       class="sunday-card progress-card {% if cp_complete %}complete{% else %}incomplete{% endif %}">
      <span>Church Progress</span>
      <span class="status-pill">
        {% if cp_complete %}Complete{% else %}Missing Data{% endif %}
      </span>
    </a>
  </div>

  <div class="field-group">
    <label for="monthly_total">Total Amount for This Month</label>
    <div class="peso-box">
      <span class="peso-symbol">₱</span>
      <input type="text"
             id="monthly_total"
             class="readonly-input peso-input"
             readonly
             value="{{ '%.2f'|format(monthly_total) }}">
    </div>
  </div>

  <form method="post" class="submit-row">
    <button type="submit"
            class="btn-primary {% if not can_submit %}btn-disabled{% endif %}"
            {% if not can_submit %}disabled{% endif %}>
      {% if status_key == 'not_submitted' %}Submit{% else %}Resubmit{% endif %}
    </button>

    <div class="status-box
        {% if status_key == 'not_submitted' %}status-neutral
        {% elif status_key == 'pending' %}status-pending
        {% elif status_key == 'approved' %}status-approved
        {% endif %}">
      {% if status_key == 'not_submitted' %}
        Not submitted
      {% elif status_key == 'pending' %}
        Pending AO approval
      {% elif status_key == 'approved' %}
        Approved by AO
      {% endif %}
    </div>
  </form>

  <p class="muted small">
    Submit/Resubmit is enabled only when all Sunday reports for the month are complete (green)
    <strong>and</strong> the Church Progress form is complete.
  </p>
</section>
{% endblock %}
