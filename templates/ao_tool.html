{% extends "base.html" %}

{% block content %}
<div class="card">
  <h1>Church Status</h1>
  <p style="font-style: italic; margin-top: -5px;">
    Hello Pastor {{ session.ao_username or "Area Overseer" }}
  </p>

  <!-- Year selector -->
  <form method="get" style="margin-bottom: 1rem;">
    <label for="year">Select Year:</label>
    <select id="year" name="year" onchange="this.form.submit()">
      {% for y in year_options %}
        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
    <noscript><button type="submit">Go</button></noscript>
  </form>

  {% for m in months %}
    {% set status_class = "" %}
    {% if m.status_key == "approved" %}
      {% set status_class = "status-approved" %}
    {% elif m.status_key == "pending" %}
      {% set status_class = "status-pending" %}
    {% elif m.status_key == "not_submitted" %}
      {% set status_class = "status-not-submitted" %}
    {% endif %}

    <div class="month-card {{ status_class }}">
      <button type="button"
              class="month-header"
              onclick="toggleMonthDetails('month-{{ m.month }}')">
        <span>{{ m.name }}</span>
        {% if m.status_key == "approved" %}
          <span class="status-pill approved">Approved</span>
        {% elif m.status_key == "pending" %}
          <span class="status-pill pending">Pending</span>
        {% else %}
          <span class="status-pill not-submitted">Not Submitted</span>
        {% endif %}
        <span class="chevron">▼</span>
      </button>

      <div id="month-{{ m.month }}" class="month-details">
        {% if m.has_data %}
          <p>
            <strong>Church:</strong> {{ m.church or "N/A" }}<br>
            <strong>Total amount for this month:</strong>
            ₱{{ "%.2f"|format(m.total_amount) }}<br>
            <strong>Sheet status:</strong>
            {{ m.sheet_status or "Pending AO approval" }}
          </p>

          <p>
            <strong>Attendance change vs previous month:</strong>
            {% if m.attendance_change is not none %}
              {% if m.attendance_change >= 0 %}
                <span style="color: green;">
                  +{{ "%.1f"|format(m.attendance_change) }}%
                </span>
              {% else %}
                <span style="color: red;">
                  {{ "%.1f"|format(m.attendance_change) }}%
                </span>
              {% endif %}
            {% else %}
              N/A
            {% endif %}
          </p>

          <form method="post"
                action="{{ url_for('ao_month_detail', year=m.year, month=m.month) }}"
                style="margin-top: 0.5rem;">
            <button name="action" value="approve" class="btn-primary">
              Approve
            </button>
            <button name="action" value="pending" class="btn-secondary">
              Set as Pending
            </button>
          </form>
        {% else %}
          <p>No report submitted in Google Sheets for this month.</p>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<style>
  .month-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    overflow: hidden;
  }
  .month-header {
    width: 100%;
    padding: 0.75rem 1rem;
    border: none;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    font-size: 1.05rem;
  }
  .month-details {
    display: none;
    padding: 0.75rem 1rem 1rem 1rem;
    background: #fff;
  }
  .chevron {
    margin-left: 0.5rem;
    font-size: 0.8rem;
  }
  .status-approved .month-header {
    border-left: 5px solid #1a7f2a;
  }
  .status-pending .month-header {
    border-left: 5px solid #c79a00;
  }
  .status-not-submitted .month-header {
    border-left: 5px solid #c62828;
  }
  .status-pill {
    font-size: 0.8rem;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    color: #fff;
  }
  .status-pill.approved {
    background: #1a7f2a;
  }
  .status-pill.pending {
    background: #c79a00;
  }
  .status-pill.not-submitted {
    background: #c62828;
  }
</style>

<script>
  function toggleMonthDetails(id) {
    var el = document.getElementById(id);
    if (!el) return;
    if (el.style.display === "block") {
      el.style.display = "none";
    } else {
      el.style.display = "block";
    }
  }
</script>
{% endblock %}
