{% extends "base.html" %}
{% block title %}Church Status{% endblock %}

{% block content %}
<section class="card">
  <h2>Church Status</h2>
  <p class="muted small"><i>AO View – Monthly Church Summary</i></p>

  <!-- FILTERS -->
  <form method="GET" action="{{ url_for('ao_church_status') }}" class="form-inline" style="gap:10px; flex-wrap:wrap;">
    <label><b>Church:</b></label>
    <select name="church">
      {% for c in churches %}
        <option value="{{ c }}" {% if c == selected_church %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>

    <label><b>Year:</b></label>
    <select name="year">
      {% for y in year_options %}
        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>

    <label><b>Month:</b></label>
    <select name="month">
      {% for name, val in month_names %}
        <option value="{{ val }}" {% if val == month %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>

    <button class="btn-secondary" type="submit">View</button>
  </form>

  <hr>

  {% if stats.rows == 0 %}
    <p class="muted">No data submitted for this church in this month.</p>
  {% else %}

  <!-- STATUS -->
  <p>
    <b>Status:</b>
    {% if stats.sheet_status == "Approved" %}
      <span class="tag green">Approved</span>
    {% else %}
      <span class="tag yellow">Pending AO approval</span>
    {% endif %}
  </p>

  {% if attendance_change is not none %}
    <p class="small">
      Attendance change vs last month:
      <b>{{ "%.1f"|format(attendance_change) }}%</b>
    </p>
  {% endif %}

  <!-- FINANCIALS -->
  <h3>Financial Summary</h3>
  <ul>
    <li>Total Tithes: {{ "%.2f"|format(stats.totals.tithes) }}</li>
    <li>Total Offering: {{ "%.2f"|format(stats.totals.offering) }}</li>
    <li>Total Personal Tithes: {{ "%.2f"|format(stats.totals.personal_tithes) }}</li>
    <li>Total Mission Offering: {{ "%.2f"|format(stats.totals.mission_offering) }}</li>
    <li><b>Total Amount to Send:</b> {{ "%.2f"|format(stats.totals.amount_to_send) }}</li>
  </ul>

  <!-- AVERAGES -->
  <h3>Average Attendance</h3>
  <ul>
    <li>Adult: {{ "%.1f"|format(stats.avg.adult) }}</li>
    <li>Youth: {{ "%.1f"|format(stats.avg.youth) }}</li>
    <li>Children: {{ "%.1f"|format(stats.avg.children) }}</li>
  </ul>

  <h3>Average Church Progress</h3>
  <ul>
    <li>Received Jesus: {{ "%.1f"|format(stats.avg.received_jesus) }}</li>
    <li>Existing Bible Study: {{ "%.1f"|format(stats.avg.existing_bible_study) }}</li>
    <li>New Bible Study: {{ "%.1f"|format(stats.avg.new_bible_study) }}</li>
    <li>Water Baptized: {{ "%.1f"|format(stats.avg.water_baptized) }}</li>
    <li>Holy Spirit Baptized: {{ "%.1f"|format(stats.avg.holy_spirit_baptized) }}</li>
    <li>Children’s Dedication: {{ "%.1f"|format(stats.avg.childrens_dedication) }}</li>
    <li>Healed: {{ "%.1f"|format(stats.avg.healed) }}</li>
  </ul>

  <!-- APPROVAL -->
  <form method="POST" action="{{ url_for('ao_church_status') }}">
    <input type="hidden" name="church" value="{{ selected_church }}">
    <input type="hidden" name="year" value="{{ year }}">
    <input type="hidden" name="month" value="{{ month }}">
    <input type="hidden" name="action" value="approve">

    <button class="btn-primary" type="submit"
      {% if stats.sheet_status == "Approved" %}disabled{% endif %}>
      {% if stats.sheet_status == "Approved" %}Approved{% else %}Approve{% endif %}
    </button>
  </form>

  {% endif %}

  <br>
  <a href="{{ url_for('ao_tool') }}">← Back to AO Tool</a>
</section>
{% endblock %}
