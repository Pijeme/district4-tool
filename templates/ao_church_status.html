{% extends "base.html" %}
{% block title %}Church Status - District 4 Tool{% endblock %}

{% block content %}
<section class="card">
  <h2>Church Status</h2>
  <p class="muted small">
    Overview of all churches per month (Google Sheets source). Month turns <b>green</b> only if <b>all churches</b> submitted.
  </p>

  <form method="GET" action="{{ url_for('ao_church_status') }}" style="margin-bottom: 14px;">
    <label class="small"><b>Year:</b></label>
    <select name="year" onchange="this.form.submit()">
      {% for y in year_options %}
        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </form>

  <div class="form-vertical">
    {% for m in months %}
      <button type="button"
              class="btn-secondary"
              onclick="toggleMonth('{{ m.month }}')"
              style="
                width:100%;
                border: 2px solid #111;
                {% if m.all_reported %}
                  background:#e9ffe9;
                {% else %}
                  background:#ffe9e9;
                {% endif %}
              ">
        <span style="display:flex; justify-content:space-between; align-items:center;">
          <span><b>{{ m.name }}</b></span>
          <span style="font-size:18px;">▾</span>
        </span>
      </button>

      <div id="month-{{ m.month }}" style="display:none; margin: 10px 0 16px 0;">
        {% for c in m.churches %}
          <div class="card" style="margin: 10px 0; border:2px solid #111;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <div>
                <div><b>{{ c.church }}</b></div>
                <div class="muted small">
                  {% if c.rows > 0 %}
                    Rows: {{ c.rows }}
                    {% if c.attendance_change is not none %}
                      • Attendance change: <b>{{ "%.1f"|format(c.attendance_change) }}%</b>
                    {% endif %}
                  {% else %}
                    No report submitted for this month.
                  {% endif %}
                </div>
              </div>

              {% if c.rows == 0 %}
                <span style="padding:6px 10px; border-radius:999px; border:1px solid #a11; background:#ffd7d7; font-weight:800; font-size:12px;">
                  Not submitted
                </span>
              {% else %}
                {% if c.status_key == "approved" %}
                  <span style="padding:6px 10px; border-radius:999px; border:1px solid #1a7f1a; background:#d7ffd7; font-weight:800; font-size:12px;">
                    Approved
                  </span>
                {% else %}
                  <span style="padding:6px 10px; border-radius:999px; border:1px solid #9a7b00; background:#fff4cc; font-weight:800; font-size:12px;">
                    Pending
                  </span>
                {% endif %}
              {% endif %}
            </div>

            {% if c.rows > 0 %}
              <div class="small" style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:8px 14px;">
                <div><b>Total Amount to Send:</b> {{ "%.2f"|format(c.totals.amount_to_send) }}</div>
                <div><b>Total Tithes:</b> {{ "%.2f"|format(c.totals.tithes) }}</div>

                <div><b>Total Offering:</b> {{ "%.2f"|format(c.totals.offering) }}</div>
                <div><b>Total Personal Tithes:</b> {{ "%.2f"|format(c.totals.personal_tithes) }}</div>

                <div><b>Total Mission Offering:</b> {{ "%.2f"|format(c.totals.mission_offering) }}</div>
                <div><b>Avg Attendance:</b> A {{ "%.1f"|format(c.avg.adult) }} / Y {{ "%.1f"|format(c.avg.youth) }} / C {{ "%.1f"|format(c.avg.children) }}</div>

                <div><b>Avg Received Jesus:</b> {{ "%.1f"|format(c.avg.received_jesus) }}</div>
                <div><b>Avg Bible Study:</b> Existing {{ "%.1f"|format(c.avg.existing_bible_study) }} / New {{ "%.1f"|format(c.avg.new_bible_study) }}</div>

                <div><b>Avg Baptism:</b> Water {{ "%.1f"|format(c.avg.water_baptized) }} / Holy Spirit {{ "%.1f"|format(c.avg.holy_spirit_baptized) }}</div>
                <div><b>Avg Others:</b> Dedication {{ "%.1f"|format(c.avg.childrens_dedication) }} / Healed {{ "%.1f"|format(c.avg.healed) }}</div>
              </div>

              <form method="POST" action="{{ url_for('ao_church_status_approve') }}" style="margin-top:10px;">
                <input type="hidden" name="year" value="{{ m.year }}">
                <input type="hidden" name="month" value="{{ m.month }}">
                <input type="hidden" name="church" value="{{ c.church }}">

                <button class="btn-primary" type="submit" {% if c.status_key == "approved" %}disabled{% endif %}>
                  {% if c.status_key == "approved" %}Approved{% else %}Approve{% endif %}
                </button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div style="margin-top:14px;">
    <a href="{{ url_for('ao_tool') }}" class="btn-secondary">← Back to AO Tool</a>
  </div>
</section>

<script>
  function toggleMonth(m) {
    const el = document.getElementById("month-" + m);
    if (!el) return;
    el.style.display = (el.style.display === "block") ? "none" : "block";
  }
</script>
{% endblock %}
